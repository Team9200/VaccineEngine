# -*- coding:utf-8 -*-
# Author : kjy
# Date : 18. 9. 27
# Version : v1.0
# Explanation : 모듈 스켈레톤 코드

import linvsharelib
import os
import shutil
import json
import time

class LVModule:
    def init(self, pluginPath):
        pass

    def uninit(self):
        pass

    def scan(self, filehandle, filename, fileformat):
        try:
            mm = filehandle

            if 'ff_pe' in fileformat:
                ff = fileformat['ff_pe']

                for section in ff['pe']['Sections']:
                    if (section['Characteristics'] & 0x20000000) == 0x20000000:
                        fsize = section['SizeRawData']
                        if fsize and linvsharelib.handle_pattern_md5.match_size('emalware', fsize):
                            foff = section['PointerRawData']
                            fmd5 = linvsharelib.md5(mm[foff:foff+fsize])

                            vname = linvsharelib.handle_pattern_md5.scan('emalware', fsize, fmd5)
                            if vname:
                                return True, vname, 0
        except IOError:
            pass

        return False, '', -1

    def disinfect(self, filename, malware_id):
        try:
            if malware_id == 0:
                try:
                    shutil.move(filename, './tmp')
                except shutil.Error:
                    os.remove(filename)

                quarantine = open('./tmp/quarantine.json', 'a')
                now = time.localtime()
                s = "%04d-%02d-%02d %02d:%02d:%02d" % (now.tm_year, now.tm_mon, now.tm_mday, now.tm_hour, now.tm_min, now.tm_sec)
                data = json.dumps({'timestamp': s, 'filename': filename, 'malwarename': 'eicar'})
                quarantine.write(data)
                quarantine.close()
                
                return True
        except IOError:
            pass
        return False

    def virusList(self):
        pass

    def getInfo(self):
        info = dict()

        info['author'] = 'kjy'
        info['version'] = 'v1.0'
        info['explanation'] = 'emalware engine'
        info['moduleName'] = 'emalware'
        info['sigNum'] = linvsharelib.handle_pattern_md5.get_sign_num('emalware')

        return info
